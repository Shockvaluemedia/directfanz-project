interface Vulnerability {
  id: string;
  severity: 'low' | 'medium' | 'high' | 'critical';
  package: string;
  version: string;
  title: string;
  description: string;
  fixedIn?: string;
  patchAvailable: boolean;
}

export class VulnerabilityManager {
  private vulnerabilities: Map<string, Vulnerability> = new Map();

  async scanDependencies(): Promise<Vulnerability[]> {
    try {
      // In production, this would integrate with npm audit, Snyk, etc.
      const auditResult = await this.runNpmAudit();
      return this.parseAuditResults(auditResult);
    } catch (error) {
      console.error('Vulnerability scan failed:', error);
      return [];
    }
  }

  private async runNpmAudit(): Promise<any> {
    // Mock audit results for testing
    return {
      vulnerabilities: {
        'test-package': {
          severity: 'high',
          via: ['CVE-2023-1234'],
          effects: [],
          range: '<1.0.0',
          nodes: ['node_modules/test-package'],
          fixAvailable: true,
        },
      },
    };
  }

  private parseAuditResults(auditResult: any): Vulnerability[] {
    const vulnerabilities: Vulnerability[] = [];
    
    Object.entries(auditResult.vulnerabilities || {}).forEach(([pkg, vuln]: [string, any]) => {
      const vulnerability: Vulnerability = {
        id: `${pkg}-${Date.now()}`,
        severity: vuln.severity,
        package: pkg,
        version: vuln.range || 'unknown',
        title: `Vulnerability in ${pkg}`,
        description: `Security issue found in ${pkg}`,
        fixedIn: vuln.fixAvailable ? 'latest' : undefined,
        patchAvailable: Boolean(vuln.fixAvailable),
      };
      
      vulnerabilities.push(vulnerability);
      this.vulnerabilities.set(vulnerability.id, vulnerability);
    });
    
    return vulnerabilities;
  }

  async getVulnerabilitiesBySeverity(severity: Vulnerability['severity']): Promise<Vulnerability[]> {
    return Array.from(this.vulnerabilities.values())
      .filter(vuln => vuln.severity === severity);
  }

  async getCriticalVulnerabilities(): Promise<Vulnerability[]> {
    return this.getVulnerabilitiesBySeverity('critical');
  }

  async generateSecurityReport(): Promise<{
    summary: {
      total: number;
      critical: number;
      high: number;
      medium: number;
      low: number;
    };
    vulnerabilities: Vulnerability[];
    recommendations: string[];
  }> {
    const vulnerabilities = Array.from(this.vulnerabilities.values());
    
    const summary = {
      total: vulnerabilities.length,
      critical: vulnerabilities.filter(v => v.severity === 'critical').length,
      high: vulnerabilities.filter(v => v.severity === 'high').length,
      medium: vulnerabilities.filter(v => v.severity === 'medium').length,
      low: vulnerabilities.filter(v => v.severity === 'low').length,
    };

    const recommendations = this.generateRecommendations(vulnerabilities);

    return {
      summary,
      vulnerabilities,
      recommendations,
    };
  }

  private generateRecommendations(vulnerabilities: Vulnerability[]): string[] {
    const recommendations: string[] = [];
    
    const criticalCount = vulnerabilities.filter(v => v.severity === 'critical').length;
    if (criticalCount > 0) {
      recommendations.push(`Immediately address ${criticalCount} critical vulnerabilities`);
    }
    
    const patchableCount = vulnerabilities.filter(v => v.patchAvailable).length;
    if (patchableCount > 0) {
      recommendations.push(`Update ${patchableCount} packages with available patches`);
    }
    
    const highCount = vulnerabilities.filter(v => v.severity === 'high').length;
    if (highCount > 0) {
      recommendations.push(`Schedule fixes for ${highCount} high-severity issues within 7 days`);
    }
    
    return recommendations;
  }

  async shouldBlockDeployment(): Promise<boolean> {
    const critical = await this.getCriticalVulnerabilities();
    return critical.length > 0;
  }

  async markVulnerabilityFixed(id: string): Promise<void> {
    this.vulnerabilities.delete(id);
  }
}

export const vulnerabilityManager = new VulnerabilityManager();